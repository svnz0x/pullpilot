(function(){const m=document.createElement("link").relList;if(m&&m.supports&&m.supports("modulepreload"))return;for(const p of document.querySelectorAll('link[rel="modulepreload"]'))R(p);new MutationObserver(p=>{for(const f of p)if(f.type==="childList")for(const c of f.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&R(c)}).observe(document,{childList:!0,subtree:!0});function C(p){const f={};return p.integrity&&(f.integrity=p.integrity),p.referrerPolicy&&(f.referrerPolicy=p.referrerPolicy),p.crossOrigin==="use-credentials"?f.credentials="include":p.crossOrigin==="anonymous"?f.credentials="omit":f.credentials="same-origin",f}function R(p){if(p.ep)return;p.ep=!0;const f=C(p);fetch(p.href,f)}})();const F="pullpilot.bearerToken",Q=[{id:"localStorage",label:"almacenamiento local",persistent:!0},{id:"sessionStorage",label:"almacenamiento de sesión",persistent:!1}],ge=b=>({storage:b.id,storageLabel:b.label,persisted:b.persistent}),K=(b,m,C,{actionType:R}={})=>{try{const p=b==null?void 0:b[m.id];if(!p||typeof p[R||"setItem"]!="function")throw new Error(`Storage ${m.id} no disponible`);const c=C(p);return{ok:!0,...ge(m),action:R||null,value:c??null}}catch(p){return{ok:!1,...ge(m),action:R||null,error:p}}},W=b=>b.filter(m=>m&&m.ok===!1),xe=b=>b.length>0&&b.every(m=>m.ok===!1),De=(b=globalThis==null?void 0:globalThis.window)=>{const m=b??{};return{readToken:()=>{const f=Q.map(S=>K(m,S,d=>d.getItem(F),{actionType:"getItem"}));let c=null;for(const S of f)if(S.ok){const d=typeof S.value=="string"?S.value:null;S.value=d,!c&&d&&(c={...S,value:d})}else S.value=null;const N=W(f);return{ok:!xe(f),operation:"read",token:(c==null?void 0:c.value)??null,storage:(c==null?void 0:c.storage)??null,storageLabel:(c==null?void 0:c.storageLabel)??null,persisted:(c==null?void 0:c.persisted)??!1,fallbackUsed:!!(c&&c.storage!==Q[0].id),attempts:f,errors:N,hadErrors:N.length>0}},clearToken:(f="clear")=>{const c=Q.map(T=>K(m,T,S=>(S.removeItem(F),null),{actionType:"removeItem"})),N=W(c);return{ok:N.length===0,operation:f,storage:null,storageLabel:null,persisted:!1,fallbackUsed:!1,attempts:c,errors:N,hadErrors:N.length>0}},persistToken:f=>{const c=[],[N,...T]=Q,S=K(m,N,L=>(L.setItem(F,f),f),{actionType:"setItem"});if(c.push(S),S.ok){for(const v of T){const A=K(m,v,J=>(J.removeItem(F),null),{actionType:"removeItem"});c.push(A)}const L=W(c);return{ok:L.length===0,operation:"write",storage:S.storage,storageLabel:S.storageLabel,persisted:S.persisted,fallbackUsed:!1,attempts:c,errors:L,hadErrors:L.length>0}}let d=null;for(const L of T){const v=K(m,L,A=>(A.setItem(F,f),f),{actionType:"setItem"});v.fallback=!0,c.push(v),!d&&v.ok&&(d=v)}const E=W(c);return d?{ok:!0,operation:"write",storage:d.storage,storageLabel:d.storageLabel,persisted:d.persisted,fallbackUsed:!0,attempts:c,errors:E,hadErrors:E.length>0}:{ok:!1,operation:"write",storage:null,storageLabel:null,persisted:!1,fallbackUsed:!1,attempts:c,errors:E,hadErrors:E.length>0}}}};(()=>{const b=document.body,m=document.getElementById("token-form"),C=document.getElementById("token-input"),R=document.getElementById("login-status"),p=document.getElementById("clear-token"),f=document.getElementById("remember-token"),c=document.getElementById("logout-button"),N=document.getElementById("config-form"),T=document.getElementById("config-fields"),S=document.getElementById("reset-config"),d=document.getElementById("config-status"),E=document.getElementById("log-select"),L=document.getElementById("log-content"),v=document.getElementById("log-meta"),A=document.getElementById("logs-status"),J=document.getElementById("refresh-logs");let M=null,j=null,Y=null;const z=De(window),_=(()=>{let e=null;const o=t=>/^[a-zA-Z][a-zA-Z\d+.-]*:/.test(t),r=()=>{if(e)return e;const t=document.querySelector("base[href]");if(t){const u=t.getAttribute("href");if(u)try{return e=new URL(u,window.location.href),e}catch(w){console.warn("Base href inválido; se ignorará.",w)}}const{origin:n,pathname:s}=window.location,l="/ui/";let i="/";if(s.endsWith("/ui"))i=`${s}/`;else if(s.includes(l))i=s.slice(0,s.indexOf(l)+l.length);else if(s.endsWith("/"))i=s;else{const u=s.lastIndexOf("/");i=u>=0?s.slice(0,u+1):"/"}try{e=new URL(i,n)}catch(u){console.warn("No se pudo resolver la base a partir de window.location.",u),e=new URL("/",n)}return e};return(t="")=>{if(t instanceof URL)return t.toString();const n=typeof t=="string"?t.trim():"";if(!n)return r().toString();if(o(n))return n;const s=n.startsWith("/")?n.slice(1):n;return new URL(s,r()).toString()}})(),I=(e,o="info")=>{R&&(R.textContent=e,R.classList.toggle("is-success",o==="success"),R.classList.toggle("is-error",o==="error"))},H={read:"No se pudo acceder al almacenamiento local en este navegador. El token no se recordará automáticamente.",write:"No se pudo recordar el token en este navegador. El token solo estará disponible en esta sesión.",remove:"No se pudo actualizar el token almacenado en este navegador. El token podría seguir guardado.",clear:"No se pudo olvidar el token almacenado en este navegador. Es posible que debas borrarlo manualmente.",generic:"No se pudo acceder al almacenamiento local en este navegador."},X=()=>{f&&(f.checked=!1,f.disabled=!0,f.setAttribute("data-storage-unavailable","true"))},pe=e=>(Array.isArray(e==null?void 0:e.errors)?e.errors:[]).some(r=>(r==null?void 0:r.storage)==="localStorage"),he=e=>e!=null&&e.storageLabel?e.storageLabel:(e==null?void 0:e.storage)==="sessionStorage"?"el almacenamiento de sesión":"un almacenamiento alternativo",ye=e=>{const o=he(e);return(e==null?void 0:e.operation)==="read"?`Se recuperó el token usando ${o} porque el almacenamiento local no está disponible. El token se conservará solo durante esta sesión.`:e!=null&&e.persisted?`El token se recordará usando ${o} porque el almacenamiento local no está disponible.`:`No se pudo usar el almacenamiento local. El token se guardará solo durante esta sesión (${o}).`},P=(e,{message:o,tone:r="error",silent:t=!1}={})=>{if(!e)return{handled:!1};if(e.ok===!1){X();const n=o||H[e.operation]||H.generic;return t||I(n,r),{handled:!0,message:n,tone:r,status:e}}if(e.fallbackUsed){X();const n=o||ye(e),s=r??"error";return t||I(n,s),{handled:!0,message:n,tone:s,status:e}}if(e.hadErrors&&pe(e)){X();const n=o||H[e.operation]||H.generic;return t||I(n,r),{handled:!0,message:n,tone:r,status:e}}return{handled:!1,status:e}},V=z.readToken();Y=(V==null?void 0:V.token)??null;const se=P(V,{silent:!0}),Ee=()=>{T&&(T.innerHTML=""),M=null,d&&(d.hidden=!0,d.classList.remove("success","error"),d.textContent=""),A&&(A.hidden=!0,A.classList.remove("success","error"),A.textContent=""),E&&(E.innerHTML="",E.disabled=!0),L&&(L.textContent="Introduce un token válido para ver los logs."),v&&(v.textContent="")},ie=e=>{b.classList.toggle("authenticated",e),b.classList.toggle("requires-auth",!e),e||Ee()},B={getToken:()=>j,setToken:(e,{persist:o=!1}={})=>(j=(typeof e=="string"?e.trim():"")||null,j&&o?z.persistToken(j):z.clearToken("remove")),clearToken:()=>(j=null,z.clearToken("clear"))},ae=async(e,{persist:o=!1}={})=>{const r=typeof e=="string"?e.trim():"";if(!r){const i=new Error("TOKEN_REQUIRED");throw i.code="TOKEN_REQUIRED",i}let t;try{t=await fetch(_("auth-check"),{headers:{Authorization:`Bearer ${r}`}})}catch(i){const u=new Error("NETWORK_ERROR");throw u.cause=i,u}let n=null,s=null;if(t.status!==204)try{n=await t.json()}catch(i){s=i}if(t.status===401){const i=new Error("UNAUTHORIZED");throw i.status=t.status,s||(i.payload=n),i}if(!t.ok){const i=new Error("REQUEST_FAILED");throw i.status=t.status,s||(i.payload=n),i}if(s){const i=new Error("INVALID_RESPONSE");throw i.cause=s,i}return{success:!0,storageStatus:B.setToken(r,{persist:o})}},le=()=>{const e=new Error("UNAUTHORIZED");return e.status=401,e},ee=(e,o)=>{const r=e==null?void 0:e.payload,t=typeof o=="string"?o:"",n=new Set(["missing credentials","unauthorized"]),s={message:t,reason:"unknown"},l=(...i)=>{const u=[],w=typeof WeakSet=="function"?new WeakSet:new Set,y=g=>{const k=g.trim();if(!k)return;const x=k.toLowerCase();n.has(x)||u.includes(k)||u.push(k)},a=g=>{if(g!=null){if(typeof g=="string"){y(g);return}if(Array.isArray(g)){g.forEach(a);return}if(typeof g=="object"){if(w.has(g))return;w.add(g);const k=["detail","details","description","message","error","msg","hint","title"];k.forEach(x=>{x in g&&a(g[x])}),Object.keys(g).forEach(x=>{k.includes(x)||a(g[x])})}}};return i.forEach(a),u};if(r&&typeof r=="object"){const i=r.detail&&typeof r.detail=="object"?r.detail:null,u=typeof r.error=="string"&&r.error?r.error:typeof(i==null?void 0:i.error)=="string"?i.error:null,w=(u==null?void 0:u.toLowerCase())??null;if(w==="missing credentials"){const a=l(r.details,r.message,r.detail,i==null?void 0:i.details,i==null?void 0:i.message,i);if(a.length>0){const g=a[0];return/faltan credenciales/i.test(g)?{message:g,reason:"missing-credentials"}:/PULLPILOT_TOKEN/i.test(g)?{message:`Faltan credenciales. ${g}`,reason:"missing-credentials"}:{message:g,reason:"missing-credentials"}}return{message:"Faltan credenciales. Introduce el token proporcionado para continuar.",reason:"missing-credentials"}}const y=l(r.detail,r.description,r.message,r.details,r.error);if(y.length>0)return{message:y[0],reason:w||"generic"};if(w)return{...s,reason:w}}else if(typeof r=="string"&&r.trim())return{message:r.trim(),reason:"string-payload"};return s},ke=(e,o)=>ee(e,o).message,ce=e=>{const o=typeof e=="string"?e.trim():"",r=[];return o&&r.push(o),/PULLPILOT_TOKEN/i.test(o)||r.push("Configura la variable de entorno PULLPILOT_TOKEN en el servidor."),r.push("Reinicia el servidor después de modificar PULLPILOT_TOKEN."),r.push("El token introducido se conservará y se reutilizará automáticamente cuando el backend acepte credenciales."),r.join(" ").trim()},be=(e,o="El token ha caducado o es incorrecto. Introduce uno nuevo.")=>{const{message:r,reason:t}=ee(e,o);if(t==="missing-credentials"){const i=ce(r);U("error",i);return}const n=B.clearToken(),s=P(n,{silent:!0});m==null||m.reset();const l=s.handled?`${r} ${s.message}`:r;U("error",l)},te=async(e,o={})=>{const r=B.getToken();if(!r)throw le();const t=new Headers(o.headers||{});t.has("Authorization")||t.set("Authorization",`Bearer ${r}`);let n=e;n instanceof Request?n=new Request(_(n.url),n):(n instanceof URL||typeof n=="string")&&(n=_(n));let s;try{s=await fetch(n,{...o,headers:t})}catch(l){throw l}if(s.status===401){const l=le();try{l.payload=await s.clone().json()}catch{}throw be(l,"El token ha caducado o es incorrecto. Introduce uno nuevo."),l}return s},Se=e=>{const o=String(e);return typeof CSS<"u"&&typeof CSS.escape=="function"?CSS.escape(o):o.replace(/([\s!"#$%&'()*+,./:;<=>?@[\\\]^`{|}~])/g,"\\$1")},we=e=>{if(e&&typeof e=="object"){const o=typeof e.summary=="string"&&e.summary.trim().length?e.summary.trim():typeof e.text=="string"?e.text:typeof e.message=="string"?e.message:"",t=(Array.isArray(e.details)?e.details:e.details!=null?[e.details]:[]).map(n=>n==null?null:typeof n=="string"?n:typeof n=="object"?n.message||n.text||n.detail||JSON.stringify(n):String(n)).filter(n=>typeof n=="string"&&n.trim().length).map(n=>n.trim());return{summary:o,details:t}}return typeof e=="string"?{summary:e,details:[]}:{summary:e!=null?String(e):"",details:[]}},O=(e,o,r="info")=>{if(!e)return;const{summary:t,details:n}=we(o);if(e.textContent="",t){const s=document.createElement("span");s.textContent=t,e.appendChild(s)}if(n.length){const s=document.createElement("ul");n.forEach(l=>{const i=document.createElement("li");i.textContent=l,s.appendChild(i)}),e.appendChild(s)}e.hidden=!1,e.classList.toggle("success",r==="success"),e.classList.toggle("error",r==="error")},D=e=>{e&&(e.hidden=!0,e.classList.remove("success","error"),e.textContent="")},Le=()=>{T&&T.querySelectorAll(".config-field.is-error").forEach(e=>{e.classList.remove("is-error"),e.querySelectorAll(".value-input, textarea[data-multiline]").forEach(o=>o.removeAttribute("aria-invalid"))})},ue=[{name:"BASE_DIR",message:"Indica un directorio base absoluto y existente antes de guardar."},{name:"LOG_DIR",message:"Indica un directorio de logs absoluto y existente antes de guardar."}],ne=e=>{if(!e||typeof e!="object")return ue.slice();const o=[];return ue.forEach(r=>{const t=e[r.name];(typeof t=="string"?t.trim():t!=null?String(t).trim():"")||o.push({field:r.name,message:r.message})}),o},de=(e,o=null)=>{if(e==null)return[];const r=[],t=(n,s)=>{if(n==null)return;const l=typeof n;if(l==="string"||l==="number"||l==="boolean"){s?r.push({field:s,message:n}):r.push(String(n));return}if(Array.isArray(n)){n.forEach(i=>t(i,s));return}if(l==="object"){const i=n.field??n.name??n.key??null,u=["message","error","detail"].find(y=>{const a=n[y];return typeof a=="string"||typeof a=="number"||typeof a=="boolean"});if(i||u){const y={...n};!i&&s&&(y.field=s),r.push(y);return}const w=new Set(["message","error","detail","errors","non_field_errors"]);Object.entries(n).forEach(([y,a])=>{const g=w.has(y)?s:s||y;t(a,g)});return}r.push(String(n))};return t(e,o),r},Z=e=>{if(!T)return[];const o=de(e),r=[];return o.forEach(t=>{if(t!=null){if(typeof t=="string"){const n=t.trim();n&&r.push(n);return}if(typeof t=="object"){const n=t.field||t.name||t.key||null,s=t.message||t.error||t.detail||JSON.stringify(t),l=typeof s=="string"&&s.trim().length?s.trim():typeof s=="string"?s:String(s);if(n){const i=`.config-field[data-name="${Se(n)}"]`,u=T.querySelector(i);u&&(u.classList.add("is-error"),u.querySelectorAll(".value-input, textarea[data-multiline]").forEach(w=>w.setAttribute("aria-invalid","true"))),r.push(`${n}: ${l}`)}else l&&r.push(l);return}r.push(String(t))}}),r},G=e=>{if(e==null)return"";const o=typeof e;if(o==="string")return e.trim();if(o==="number"||o==="boolean")return String(e);if(Array.isArray(e)){for(const r of e){const t=G(r);if(t)return t}return""}if(o==="object"){const r=["error","detail","message","title"];for(const t of r)if(Object.prototype.hasOwnProperty.call(e,t)){const n=G(e[t]);if(n)return n}for(const t of Object.values(e)){const n=G(t);if(n)return n}}return""},Te=e=>{if(e==null)return null;if(Array.isArray(e))return e;if(typeof e=="object"){if(e.details!==void 0)return e.details;if(e.detail!==void 0)return e.detail;if(e.errors!==void 0)return e.errors;if(Array.isArray(e.message)||typeof e.message=="object"&&e.message!==null)return e.message;if(Array.isArray(e.error)||typeof e.error=="object"&&e.error!==null)return e.error;const o=new Set(["error","detail","message","title","status","type","code"]),r=Object.entries(e).filter(([t])=>!o.has(t));if(r.length)return Object.fromEntries(r)}return null},Ie=e=>{const o="No se pudo guardar la configuración.",r=Te(e),t=de(r),n=[];typeof e=="string"||typeof e=="number"||typeof e=="boolean"?n.push(e):Array.isArray(e)?n.push(...e):e&&typeof e=="object"&&n.push(e.error,e.detail,e.message,e.title),!n.length&&t.length&&n.push(...t);const s=n.map(i=>G(i)).find(i=>i==null?void 0:i.length)||o,l=Z(r);return{summary:s,details:l}},Ce=e=>typeof e=="boolean"?e:typeof e=="string"?e.toLowerCase()==="true":!!e,Ae=(e,o,r,t)=>{var x;const n=document.createElement("div");n.className="config-field",n.dataset.name=e.name;const s=document.createElement("label");s.htmlFor=`field-${e.name}`;const l=e.name==="BASE_DIR",i=e.name==="LOG_DIR";l?s.textContent="Carpeta de proyectos docker-compose":i?s.textContent="Carpeta de logs del updater":s.textContent=e.name,n.appendChild(s);const u=document.createElement("div");u.className="field-input";const y=o&&Object.prototype.hasOwnProperty.call(o,e.name)?o[e.name]:e.default;let a;if(l||i){a=document.createElement("input"),a.type="text",a.id=`field-${e.name}`,a.classList.add("value-input"),l?a.classList.add("base-dir-input"):i&&a.classList.add("log-dir-input"),a.dataset.type=e.type;const h=l?"Introduce una ruta absoluta (ej.: /ruta/a/proyectos)":"Introduce una ruta absoluta existente";a.placeholder=h,a.spellcheck=!1,(x=e.constraints)!=null&&x.pattern&&(a.pattern=e.constraints.pattern),a.value=y??""}else e.type==="boolean"?(a=document.createElement("input"),a.type="checkbox",a.id=`field-${e.name}`,a.className="value-input",a.dataset.type="boolean",a.checked=Ce(y)):e.constraints&&Array.isArray(e.constraints.allowed_values)&&e.constraints.allowed_values.length>0?(a=document.createElement("select"),a.id=`field-${e.name}`,a.className="value-input",a.dataset.type=e.type,e.constraints.allowed_values.forEach(q=>{const $=document.createElement("option");$.value=q,$.textContent=q,String(q)===String(y)&&($.selected=!0),a.appendChild($)})):(a=document.createElement(e.multiline?"textarea":"input"),e.multiline&&a.classList.add("multiline-input"),a.id=`field-${e.name}`,a.classList.add("value-input"),a.dataset.type=e.type,e.type==="integer"?(a.type="number",a.step="1"):e.multiline||(a.type="text"),a.value=y??"");a&&a.setAttribute("aria-describedby",`field-${e.name}-description`),u.appendChild(a);const g=`field-${e.name}-description`;if(t.has(e.name)){const h=document.createElement("textarea");h.className="multiline-input",h.id=`field-${e.name}-content`,h.dataset.multiline=e.name,h.placeholder=e.description||`Introduce el contenido asociado a ${e.name}`,h.setAttribute("aria-labelledby",g),h.value=(r==null?void 0:r[e.name])??"",u.appendChild(h)}n.appendChild(u);const k=document.createElement("p");if(k.className="field-description",k.id=g,l||i){const h=[];e.description&&h.push(e.description),l?(h.push("Ruta absoluta de la carpeta donde se buscarán los proyectos Docker Compose."),h.push("Debe existir antes de ejecutar el script y contener los proyectos docker-compose en sus subdirectorios.")):(h.push("Directorio absoluto donde se almacenarán los logs diarios del updater."),h.push("Asegúrate de crear la carpeta con permisos de escritura antes de lanzar el script.")),h.length&&(k.textContent=h[0],h.slice(1).forEach(q=>{k.appendChild(document.createElement("br"));const $=document.createElement("span");$.textContent=q,k.appendChild($)}))}else k.textContent=e.description||"Sin descripción";if(e.default!==void 0&&e.default!==null&&String(e.default).length){const h=document.createElement("span");h.className="field-default",h.textContent=`Valor por defecto: ${e.default}`,k.appendChild(document.createElement("br")),k.appendChild(h)}return n.appendChild(k),n},re=e=>{var l;const{schema:o,values:r,multiline:t,meta:n}=e;T.innerHTML="";const s=new Set((n==null?void 0:n.multiline_fields)??[]);(l=o==null?void 0:o.variables)==null||l.forEach(i=>{const u=Ae(i,r,t,s);T.appendChild(u)}),M=e},Oe=()=>{const e={values:{},multiline:{}};return T.querySelectorAll(".config-field").forEach(o=>{const r=o.dataset.name;if(!r)return;const t=o.querySelector(".value-input");if(!t)return;const n=t.dataset.type;if(n==="boolean")e.values[r]=t.checked;else if(n==="integer")e.values[r]=t.value===""?null:Number(t.value);else{const l=t.value;e.values[r]=r==="BASE_DIR"||r==="LOG_DIR"?l.trim():l}const s=o.querySelector("textarea[data-multiline]");s&&(e.multiline[r]=s.value)}),Object.keys(e.multiline).length===0&&delete e.multiline,e},Re=async()=>{D(d);try{const e=await te(_("config"));if(!e.ok)throw new Error(`Error HTTP ${e.status}`);const o=await e.json();re(o);const r=ne(o==null?void 0:o.values);return r.length?(Z(r),O(d,{summary:"Configura las rutas obligatorias antes de ejecutar el updater.",details:r},"error")):(O(d,"Configuración cargada correctamente.","success"),setTimeout(()=>D(d),2500)),!0}catch(e){return console.error(e),(e==null?void 0:e.message)==="UNAUTHORIZED"?O(d,"No se pudo cargar la configuración: introduce un token válido.","error"):O(d,"Token válido, pero el backend no devolvió la configuración. Revisa el servicio e inténtalo de nuevo.","error"),!1}},ve=async e=>{e.preventDefault(),D(d),Le();const o=Oe(),r=ne(o.values);if(r.length){Z(r),O(d,{summary:"Completa las rutas obligatorias antes de guardar.",details:r},"error");return}try{const t=await te(_("config"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),n=await t.json().catch(()=>null);if(!t.ok){const s=new Error("REQUEST_FAILED");throw s.status=t.status,s.data=n,s}n&&re(n),O(d,"Cambios guardados.","success")}catch(t){if(console.error(t),(t==null?void 0:t.message)==="UNAUTHORIZED"){O(d,"No se pudo guardar la configuración porque falta un token válido.","error");return}if(t!=null&&t.data){const n=Ie(t.data);O(d,n,"error");return}O(d,"No se pudo guardar la configuración. Revisa los datos e inténtalo de nuevo.","error")}},Ne=()=>{if(!M)return;re(M);const e=ne(M.values);e.length?(Z(e),O(d,{summary:"Se restauraron los valores cargados. Completa las rutas obligatorias antes de guardar.",details:e},"error")):(O(d,"Se restauraron los valores cargados."),setTimeout(()=>D(d),2500))},oe=async(e=null)=>{D(A);const o=new URL(_("logs"));e&&o.searchParams.set("name",e);const r=o.toString();try{const t=await te(r);if(!t.ok)throw new Error(`Error HTTP ${t.status}`);const n=await t.json();return Ue(n),!0}catch(t){return console.error(t),(t==null?void 0:t.message)==="UNAUTHORIZED"?(O(A,"Introduce un token válido para consultar los logs.","error"),L.textContent="Introduce un token válido para ver los logs."):(O(A,"No se pudieron cargar los logs.","error"),L.textContent="Sin datos disponibles."),!1}},Ue=e=>{var l,i,u,w,y;const o=Array.isArray(e.files)?e.files:[],r=e&&typeof e.notice=="string"&&e.notice.trim().length?e.notice.trim():"";if(E.innerHTML="",r?O(A,r,"error"):D(A),o.length===0){const a=document.createElement("option");a.textContent="Sin archivos de log",a.disabled=!0,a.selected=!0,E.appendChild(a),E.disabled=!0,L.textContent=r||"No se encontraron archivos .log en el directorio configurado.",v.textContent=e.log_dir?`Directorio: ${e.log_dir}`:"";return}E.disabled=!1,o.forEach(a=>{const g=document.createElement("option");g.value=a.name;const k=a.modified?new Date(a.modified).toLocaleString():"sin fecha";g.textContent=`${a.name} · ${k}`,E.appendChild(g)});const t=((l=e.selected)==null?void 0:l.name)||((i=E.options[0])==null?void 0:i.value);t&&(E.value=t),(u=e.selected)!=null&&u.content?L.textContent=e.selected.content:e.selected?L.textContent="Archivo sin contenido o no legible.":L.textContent="No hay contenido disponible para el archivo seleccionado.";const n=(w=e.selected)==null?void 0:w.size,s=(y=e.selected)!=null&&y.modified?new Date(e.selected.modified).toLocaleString():"";v.textContent=`${e.log_dir?`Directorio: ${e.log_dir}`:""}${s?` · Última modificación: ${s}`:""}${n?` · Tamaño: ${n} bytes`:""}`},fe=async({showSuccessMessage:e=!0,storageStatus:o=null}={})=>{ie(!0),D(d),D(A),m&&m.reset();const r=await Re();await oe();const t=P(o,{silent:!0}),n=t.handled?t.message:"";if(r)t.handled?I(n,t.tone||"error"):e?I("Token validado. Puedes usar la interfaz con normalidad.","success"):I("","info");else{const s="Token validado, pero no se pudo cargar la configuración. Revisa el servicio e inténtalo de nuevo.",l=n?`${s} ${n}`:s;I(l,"error")}},U=(e="info",o="Introduce el token bearer para continuar. Marca «Recordar token» solo si el equipo es de confianza.")=>{ie(!1),I(o,e),C==null||C.focus()};m==null||m.addEventListener("submit",async e=>{var r;e.preventDefault();const o=((r=C==null?void 0:C.value)==null?void 0:r.trim())??"";if(!o){I("Debes introducir un token para continuar.","error"),C==null||C.focus();return}I("Verificando token…","info");try{const t=(f==null?void 0:f.checked)??!1,n=await ae(o,{persist:t});await fe({storageStatus:n==null?void 0:n.storageStatus})}catch(t){if(console.error(t),(t==null?void 0:t.message)==="UNAUTHORIZED"||(t==null?void 0:t.status)===401){const n=ke(t,"El token proporcionado no está autorizado. Vuelve a intentarlo.");I(n,"error")}else(t==null?void 0:t.message)==="NETWORK_ERROR"?I("No se pudo verificar el token. Revisa la conexión e inténtalo de nuevo.","error"):(t==null?void 0:t.message)==="TOKEN_REQUIRED"?I("Debes introducir un token para continuar.","error"):I("No se pudo verificar el token. Inténtalo de nuevo.","error")}});const me=(e="Introduce el token bearer para continuar.",o="info")=>{const r=B.clearToken(),t=P(r,{silent:!0});if(m==null||m.reset(),t.handled){U("error",t.message);return}U(o,e)};p==null||p.addEventListener("click",()=>{me("Se olvidó el token guardado. Introduce uno nuevo.")}),c==null||c.addEventListener("click",()=>{me("Sesión cerrada. Introduce un token válido para continuar.")}),N.addEventListener("submit",ve),S.addEventListener("click",Ne),E.addEventListener("change",e=>{const{value:o}=e.target;!o||E.disabled||oe(o)}),J.addEventListener("click",()=>{const e=E.disabled?null:E.value;oe(e||null)}),Y?(I("Verificando token guardado…","info"),ae(Y,{persist:!0}).then(e=>fe({showSuccessMessage:!1,storageStatus:e==null?void 0:e.storageStatus})).catch(e=>{if(console.error(e),(e==null?void 0:e.message)==="UNAUTHORIZED"||(e==null?void 0:e.status)===401){const{message:r,reason:t}=ee(e,"El token guardado no es válido. Introduce uno nuevo.");if(t==="missing-credentials"){const i=ce(r);U("error",i);return}const n=B.clearToken(),s=P(n,{silent:!0}),l=s.handled?`${r} ${s.message}`:r;U("error",l)}else(e==null?void 0:e.message)==="NETWORK_ERROR"?U("error","No se pudo verificar el token guardado por un problema de red. Revisa la conexión e inténtalo de nuevo; el token seguirá guardado."):U("error","No se pudo verificar el token guardado. Inténtalo de nuevo o introduce uno nuevo.")})):se.handled?U("error",se.message):U()})();
