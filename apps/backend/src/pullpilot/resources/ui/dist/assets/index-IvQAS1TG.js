(function(){const l=document.createElement("link").relList;if(l&&l.supports&&l.supports("modulepreload"))return;for(const f of document.querySelectorAll('link[rel="modulepreload"]'))L(f);new MutationObserver(f=>{for(const m of f)if(m.type==="childList")for(const u of m.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&L(u)}).observe(document,{childList:!0,subtree:!0});function c(f){const m={};return f.integrity&&(m.integrity=f.integrity),f.referrerPolicy&&(m.referrerPolicy=f.referrerPolicy),f.crossOrigin==="use-credentials"?m.credentials="include":f.crossOrigin==="anonymous"?m.credentials="omit":m.credentials="same-origin",m}function L(f){if(f.ep)return;f.ep=!0;const m=c(f);fetch(f.href,m)}})();const me="pullpilot.bearerToken",Te=[{id:"localStorage",label:"almacenamiento local",persistent:!0},{id:"sessionStorage",label:"almacenamiento de sesión",persistent:!1}],it=i=>({storage:i.id,storageLabel:i.label,persisted:i.persistent}),pe=(i,l,c,{actionType:L}={})=>{try{const f=i==null?void 0:i[l.id];if(!f||typeof f[L||"setItem"]!="function")throw new Error(`Storage ${l.id} no disponible`);const u=c(f);return{ok:!0,...it(l),action:L||null,value:u??null}}catch(f){return{ok:!1,...it(l),action:L||null,error:f}}},ke=i=>i.filter(l=>l&&l.ok===!1),Ft=i=>i.length>0&&i.every(l=>l.ok===!1),Ht=(i=globalThis==null?void 0:globalThis.window)=>{const l=i??{};return{readToken:()=>{const m=Te.map(S=>pe(l,S,I=>I.getItem(me),{actionType:"getItem"}));let u=null;for(const S of m)if(S.ok){const I=typeof S.value=="string"?S.value:null;S.value=I,!u&&I&&(u={...S,value:I})}else S.value=null;const b=ke(m);return{ok:!Ft(m),operation:"read",token:(u==null?void 0:u.value)??null,storage:(u==null?void 0:u.storage)??null,storageLabel:(u==null?void 0:u.storageLabel)??null,persisted:(u==null?void 0:u.persisted)??!1,fallbackUsed:!!(u&&u.storage!==Te[0].id),attempts:m,errors:b,hadErrors:b.length>0}},clearToken:(m="clear")=>{const u=Te.map(y=>pe(l,y,S=>(S.removeItem(me),null),{actionType:"removeItem"})),b=ke(u);return{ok:b.length===0,operation:m,storage:null,storageLabel:null,persisted:!1,fallbackUsed:!1,attempts:u,errors:b,hadErrors:b.length>0}},persistToken:m=>{const u=[],[b,...y]=Te,S=pe(l,b,k=>(k.setItem(me,m),m),{actionType:"setItem"});if(u.push(S),S.ok){for(const E of y){const x=pe(l,E,D=>(D.removeItem(me),null),{actionType:"removeItem"});u.push(x)}const k=ke(u);return{ok:k.length===0,operation:"write",storage:S.storage,storageLabel:S.storageLabel,persisted:S.persisted,fallbackUsed:!1,attempts:u,errors:k,hadErrors:k.length>0}}let I=null;for(const k of y){const E=pe(l,k,x=>(x.setItem(me,m),m),{actionType:"setItem"});E.fallback=!0,u.push(E),!I&&E.ok&&(I=E)}const g=ke(u);return I?{ok:!0,operation:"write",storage:I.storage,storageLabel:I.storageLabel,persisted:I.persisted,fallbackUsed:!0,attempts:u,errors:g,hadErrors:g.length>0}:{ok:!1,operation:"write",storage:null,storageLabel:null,persisted:!1,fallbackUsed:!1,attempts:u,errors:g,hadErrors:g.length>0}}}},ct=i=>/^[a-zA-Z][a-zA-Z\d+.-]*:/.test(i),at=(i,l)=>{const c=i.location??{};if(c.origin&&ct(c.origin))return c.origin;if(c.protocol&&c.host)return`${c.protocol}//${c.host}`;if(c.href)try{return new(i.URL??URL)(c.href).origin}catch{}return l?`${l.protocol}//${l.host}`:""},Gt=i=>{const l=i||(typeof window<"u"?window:void 0);if(!l)throw new Error("createApiUrlBuilder requires a window-like object");const c=l.document||(typeof document<"u"?document:void 0),L=l.URL||URL;let f=null;const m=()=>{var k,E,x;if(f)return f;const u=(k=c==null?void 0:c.querySelector)==null?void 0:k.call(c,"base[href]");if(u){const D=(E=u.getAttribute)==null?void 0:E.call(u,"href");if(D)try{return f=new L(D,((x=l.location)==null?void 0:x.href)||void 0),f}catch(N){console.warn("Base href inválido; se ignorará.",N)}}const b=l.location??{},y=at(l),S=typeof b.pathname=="string"?b.pathname:"/",I="/ui/";let g="/";if(S.endsWith("/ui"))g=`${S}/`;else if(S.includes(I))g=S.slice(0,S.indexOf(I)+I.length);else if(S.endsWith("/"))g=S;else{const D=S.lastIndexOf("/");g=D>=0?S.slice(0,D+1):"/"}try{f=new L(g,y||b.href||void 0)}catch(D){console.warn("No se pudo resolver la base a partir de window.location.",D),f=new L("/",y||"http://localhost")}return f};return(u="")=>{if(u instanceof L||u instanceof URL)return u.toString();const b=typeof u=="string"?u.trim():"";if(!b)return m().toString();if(ct(b))return b;const y=m();if(b.startsWith("/")){const S=at(l,y)||y;return new L(b,S).toString()}return new L(b,y).toString()}},Vt=({authorizedFetch:i,buildApiUrl:l})=>{if(typeof i!="function")throw new TypeError("authorizedFetch must be a function");if(typeof l!="function")throw new TypeError("buildApiUrl must be a function");const c=()=>l("../schedule");return{load(){return i(c())},save(L){const f=L===void 0?void 0:JSON.stringify(L);return i(c(),{method:"PUT",headers:{"Content-Type":"application/json"},body:f})}}},Kt=new Set(["missing credentials","unauthorized"]),_e=(i,l)=>{const c=i==null?void 0:i.payload,f={message:typeof l=="string"?l:"",reason:"unknown"},m=(...u)=>{const b=[],y=typeof WeakSet=="function"?new WeakSet:new Set,S=g=>{const k=g.trim();if(!k)return;const E=k.toLowerCase();Kt.has(E)||b.includes(k)||b.push(k)},I=g=>{if(g!=null){if(typeof g=="string"){S(g);return}if(Array.isArray(g)){g.forEach(I);return}if(typeof g=="object"){if(y.has(g))return;y.add(g);const k=["detail","details","description","message","error","msg","hint","title"];k.forEach(E=>{E in g&&I(g[E])}),Object.keys(g).forEach(E=>{k.includes(E)||I(g[E])})}}};return u.forEach(I),b};if(c&&typeof c=="object"){const u=c.detail&&typeof c.detail=="object"?c.detail:null,b=typeof c.error=="string"&&c.error?c.error:typeof(u==null?void 0:u.error)=="string"?u.error:null,y=(b==null?void 0:b.toLowerCase())??null;if(y==="missing credentials"){const I=m(c.details,c.message,c.detail,u==null?void 0:u.details,u==null?void 0:u.message,u);if(I.length>0){const g=I[0];return/faltan credenciales/i.test(g)?{message:g,reason:"missing-credentials"}:/PULLPILOT_TOKEN/i.test(g)?{message:`Faltan credenciales. ${g}`,reason:"missing-credentials"}:{message:g,reason:"missing-credentials"}}return{message:"Faltan credenciales. Introduce el token proporcionado para continuar.",reason:"missing-credentials"}}const S=m(c.detail,c.description,c.message,c.details,c.error);if(S.length>0)return{message:S[0],reason:y||"generic"};if(y)return{...f,reason:y}}else if(typeof c=="string"&&c.trim())return{message:c.trim(),reason:"string-payload"};return f},Ue=i=>{const l=typeof i=="string"?i.trim():"",c=[];return l&&c.push(l),/PULLPILOT_TOKEN/i.test(l)||c.push("Configura la variable de entorno PULLPILOT_TOKEN en el servidor."),c.push("Reinicia el servidor después de modificar PULLPILOT_TOKEN."),c.push("El token introducido se conservará y se reutilizará automáticamente cuando el backend acepte credenciales."),c.join(" ").trim()},Wt=(i,{reusableToken:l=!1,hadMemoryToken:c=!1,storageOutcome:L=null}={})=>{const f=typeof i=="string"&&i.trim().length?i.trim():"",m="El token guardado se reutilizará automáticamente cuando el servidor vuelva a aceptar credenciales.",u="Introduce de nuevo el token para continuar.";let b=f;if(l?b=f?`${f} ${m}`:m:c&&(b=f?`${f} ${u}`:u),L!=null&&L.handled&&L.message){const y=L.message.trim();y&&(b=b?`${b} ${y}`:y)}return b},Zt=Object.freeze({BASE_DIR:{section:"Rutas y registros",subsection:"Directorios requeridos"},LOG_DIR:{section:"Rutas y registros",subsection:"Directorios requeridos"},LOCK_FILE:{section:"Rutas y registros",subsection:"Directorios requeridos"},LOG_RETENTION_DAYS:{section:"Rutas y registros",subsection:"Retención de logs"},EMAIL_TO:{section:"Notificaciones",subsection:"Correo electrónico"},EMAIL_FROM:{section:"Notificaciones",subsection:"Correo electrónico"},SUBJECT_PREFIX:{section:"Notificaciones",subsection:"Correo electrónico"},ATTACH_LOGS_ON:{section:"Notificaciones",subsection:"Correo electrónico"},SMTP_CMD:{section:"Notificaciones",subsection:"Cliente SMTP"},SMTP_ACCOUNT:{section:"Notificaciones",subsection:"Cliente SMTP"},SMTP_READ_ENVELOPE:{section:"Notificaciones",subsection:"Cliente SMTP"},DOCKER_TIMEOUT:{section:"Ejecución de Docker",subsection:"Tiempo de espera y concurrencia"},PARALLEL_PULL:{section:"Ejecución de Docker",subsection:"Tiempo de espera y concurrencia"},QUIET_PULL:{section:"Ejecución de Docker",subsection:"Comportamiento de pulls"},PULL_POLICY:{section:"Ejecución de Docker",subsection:"Comportamiento de pulls"},DRY_RUN:{section:"Ejecución de Docker",subsection:"Depuración"},EXCLUDE_PATTERNS:{section:"Filtrado de proyectos",subsection:"Patrones y exclusiones"},EXCLUDE_PROJECTS:{section:"Filtrado de proyectos",subsection:"Patrones y exclusiones"},PRUNE_ENABLED:{section:"Limpieza",subsection:"Prune de Docker"},PRUNE_VOLUMES:{section:"Limpieza",subsection:"Prune de Docker"},PRUNE_FILTER_UNTIL:{section:"Limpieza",subsection:"Prune de Docker"},MIN_COMPOSE_WAIT_VERSION:{section:"Compatibilidad",subsection:"Docker Compose"},COMPOSE_BIN:{section:"Compatibilidad",subsection:"Docker Compose"}}),Qt=Object.freeze({BASE_DIR:"Carpeta de proyectos docker-compose",LOG_DIR:"Carpeta de logs del updater"}),Pe=(...i)=>{for(const l of i)if(typeof l=="string"){const c=l.trim();if(c.length>0)return c}return null},Jt=i=>{if(!i||typeof i!="object")return{section:"General",subsection:null};const l=i.metadata&&typeof i.metadata=="object"?i.metadata:{},c=Zt[i.name]??null,L=Pe(c==null?void 0:c.section,i.section,l.section,l.group,l.category)??"General",f=Pe(c==null?void 0:c.subsection,i.subsection,l.subsection,l.groupLabel,l.subcategory);return{section:L,subsection:f}},Xt=({logDir:i,modified:l,size:c})=>{const L=[];return i&&L.push(`Directorio: ${i}`),l&&L.push(`Última modificación: ${l}`),c!=null&&L.push(`Tamaño: ${c} bytes`),L.join(" · ")},Yt=i=>i?Object.prototype.hasOwnProperty.call(i,"content")?i.content??"":"Archivo sin contenido o no legible.":"No hay contenido disponible para el archivo seleccionado.",en=({auth:i,buildApiUrl:l,handleUnauthorized:c,createUnauthorizedError:L})=>{if(!i||typeof i.getToken!="function")throw new TypeError("createAuthorizedFetch requires an auth object with getToken");if(typeof l!="function")throw new TypeError("createAuthorizedFetch requires a buildApiUrl function");if(typeof c!="function")throw new TypeError("createAuthorizedFetch requires a handleUnauthorized function");if(typeof L!="function")throw new TypeError("createAuthorizedFetch requires a createUnauthorizedError function");const f=m=>m instanceof URL?m.toString():m;return async(m,u={})=>{const b=i.getToken();if(!b)throw L();const y=new Headers(u.headers||{});y.has("Authorization")||y.set("Authorization",`Bearer ${b}`);let S=m,I={...u,headers:y};if(S instanceof Request){const k=S,E=new Headers(k.headers);y.forEach((ne,z)=>E.set(z,ne));const x=new Request(k,{method:k.method,headers:E,mode:k.mode,credentials:k.credentials,signal:u.signal??k.signal??null}),D=f(l(k.url)),N=x.method||k.method||"GET",te=!/^(GET|HEAD)$/i.test(N),j={method:N,headers:E,mode:x.mode,credentials:x.credentials,signal:x.signal};te&&(j.body=x.body,typeof window>"u"&&(j.duplex="half")),S=new Request(D,j),I=void 0}else(S instanceof URL||typeof S=="string")&&(S=f(l(S)));let g;try{g=await fetch(S,I)}catch(k){throw k}if(g.status===401){const k=L();try{k.payload=await g.clone().json()}catch{}throw c(k,"El token ha caducado o es incorrecto. Introduce uno nuevo."),k}return g}},tn=()=>{let i=0,l=null;return{start:()=>{i+=1,l!=null&&l.abort&&l.abort();let m=null;return typeof AbortController<"u"&&(m=new AbortController),l=m,{id:i,controller:m,release:()=>{l===m&&(l=null)}}},isLatest:m=>m===i,getSignal:m=>m==null?void 0:m.signal}},nn=()=>{const i=new Map;return{schedule:(f,m,u)=>{if(!f||typeof m!="function"||typeof u!="number")return null;const b=i.get(f);b!=null&&clearTimeout(b);const y=setTimeout(()=>{i.delete(f),m()},u);return i.set(f,y),y},clear:f=>{if(!f)return;const m=i.get(f);m!=null&&(clearTimeout(m),i.delete(f))},clearAll:()=>{i.forEach(f=>{clearTimeout(f)}),i.clear()}}},sn=(i,l)=>{var L,f,m,u;if(!i)return;const c=i.dataset;if(!c){l&&i.disabled!==!0&&(i.disabled=!0);return}if(l){if(c.initialLoadDisabled==="true"){i.disabled=!0,(L=i.setAttribute)==null||L.call(i,"aria-disabled","true");return}c.initialLoadDisabled="true",c.initialLoadWasDisabled=i.disabled?"true":"false",(f=i.setAttribute)==null||f.call(i,"aria-disabled","true"),i.disabled||(i.disabled=!0);return}if(c.initialLoadDisabled==="true"){const b=c.initialLoadWasDisabled==="true";delete c.initialLoadDisabled,delete c.initialLoadWasDisabled,b?(m=i.setAttribute)==null||m.call(i,"aria-disabled","true"):(i.disabled=!1,(u=i.removeAttribute)==null||u.call(i,"aria-disabled"))}},rn=({authorizedFetch:i,buildApiUrl:l,buildProcessStatusMessage:c,buildErrorStatusPayload:L,showStatus:f,hideStatus:m,setTestConfigButtonLoading:u,configStatus:b})=>{if(typeof i!="function")throw new Error("createConfigTestRunner requires an authorizedFetch function");if(typeof l!="function")throw new Error("createConfigTestRunner requires a buildApiUrl function");return async()=>{m(b),u(!0),f(b,"Ejecutando prueba del updater…");try{const y=await i(l("run-test"),{method:"POST"}),S=await y.json().catch(()=>null);if(!y.ok){const E=new Error("REQUEST_FAILED");throw E.status=y.status,E.data=S,E}const{summary:I,details:g,tone:k}=c(S);f(b,{summary:I,details:g},k)}catch(y){if(console.error(y),(y==null?void 0:y.message)==="UNAUTHORIZED"){f(b,"No se pudo ejecutar la prueba porque falta un token válido.","error");return}if(y!=null&&y.data){const S=L(y.data,{defaultSummary:"No se pudo ejecutar la prueba del updater.",container:null});f(b,S,"error");return}if(typeof(y==null?void 0:y.status)=="number"){const S="El backend devolvió un error (código "+y.status+") al ejecutar la prueba.";f(b,S,"error");return}f(b,"No se pudo ejecutar la prueba del updater. Revisa los logs e inténtalo de nuevo.","error")}finally{u(!1)}}},on=()=>{const i=document.body,l=document.getElementById("token-form"),c=document.getElementById("token-input"),L=document.getElementById("login-status"),f=document.getElementById("clear-token"),m=document.getElementById("remember-token"),u=document.getElementById("logout-button"),b=document.getElementById("config-form"),y=document.getElementById("config-fields"),S=document.getElementById("save-config"),I=document.getElementById("reset-config"),g=document.getElementById("retry-config"),k=document.getElementById("test-config"),E=document.getElementById("config-status"),x=document.getElementById("schedule-form"),D=document.getElementById("schedule-fields"),N=document.getElementById("schedule-mode"),te=(D==null?void 0:D.querySelector('[data-name="expression"]'))??null,j=document.getElementById("schedule-expression"),ne=(D==null?void 0:D.querySelector('[data-name="datetime"]'))??null,z=document.getElementById("schedule-datetime"),R=document.getElementById("schedule-status"),lt=document.getElementById("save-schedule"),ge=document.getElementById("reset-schedule"),C=document.getElementById("log-select"),q=document.getElementById("log-content"),B=document.getElementById("log-meta"),F=document.getElementById("logs-status"),P=document.getElementById("refresh-logs"),se=document.querySelector("main"),ae=document.getElementById("initial-loading-banner"),we=()=>typeof document>"u"?null:document,Me=new WeakMap,ce=new Set;let je=!1;const $e=e=>{if(!e)return null;let t=Me.get(e);return t||(t={closeTimeoutId:null,transitionEndHandler:null},Me.set(e,t)),t},Ie=(e,t)=>{var o,h,a,T;if(!t){(o=e==null?void 0:e.setAttribute)==null||o.call(e,"aria-expanded","false");return}const n=$e(t);if(!n){(h=e==null?void 0:e.setAttribute)==null||h.call(e,"aria-expanded","false");return}if(t.hidden){(a=e==null?void 0:e.setAttribute)==null||a.call(e,"aria-expanded","false"),t.classList.remove("is-visible");return}n.transitionEndHandler&&(t.removeEventListener("transitionend",n.transitionEndHandler),n.transitionEndHandler=null),n.closeTimeoutId&&(clearTimeout(n.closeTimeoutId),n.closeTimeoutId=null);const s=()=>{t.hidden||(t.hidden=!0),t.classList.remove("is-visible"),n.transitionEndHandler&&(t.removeEventListener("transitionend",n.transitionEndHandler),n.transitionEndHandler=null),n.closeTimeoutId&&(clearTimeout(n.closeTimeoutId),n.closeTimeoutId=null)},r=A=>{A.target===t&&s()};t.classList.remove("is-visible"),n.transitionEndHandler=r,t.addEventListener("transitionend",r),n.closeTimeoutId=window.setTimeout(()=>{s()},250),(T=e==null?void 0:e.setAttribute)==null||T.call(e,"aria-expanded","false")},ut=(e,t)=>{var s,r,o;if(!t){(s=e==null?void 0:e.setAttribute)==null||s.call(e,"aria-expanded","true");return}const n=$e(t);if(!n){(r=e==null?void 0:e.setAttribute)==null||r.call(e,"aria-expanded","true");return}n.transitionEndHandler&&(t.removeEventListener("transitionend",n.transitionEndHandler),n.transitionEndHandler=null),n.closeTimeoutId&&(clearTimeout(n.closeTimeoutId),n.closeTimeoutId=null),t.hidden?(t.hidden=!1,t.classList.remove("is-visible"),requestAnimationFrame(()=>{t.classList.add("is-visible")})):t.classList.add("is-visible"),(o=e==null?void 0:e.setAttribute)==null||o.call(e,"aria-expanded","true")},dt=()=>{if(je)return;const e=we();e!=null&&e.addEventListener&&(e.addEventListener("pointerdown",t=>{ce.forEach(n=>{const{toggle:s,panel:r}=n;if(!s||!r||!e.contains(s)){ce.delete(n);return}s.getAttribute("aria-expanded")==="true"&&(s.contains(t.target)||r.contains(t.target)||Ie(s,r))})}),je=!0)},ft=(e,t)=>{if(!e||!t)return;e.getAttribute("aria-expanded")==="true"?Ie(e,t):ut(e,t)},qe=(e,t)=>{if(!e||!t||e.dataset.infoToggleBound==="true")return;dt(),ce.add({toggle:e,panel:t});const n=s=>{s.key==="Escape"&&(Ie(e,t),e.blur())};e.addEventListener("click",s=>{s.preventDefault(),ft(e,t)}),e.addEventListener("keydown",n),t.addEventListener("keydown",n),e.dataset.infoToggleBound="true"},mt=()=>{const e=we();e!=null&&e.querySelectorAll&&e.querySelectorAll(".info-toggle").forEach(t=>{if(t.dataset.infoToggleBound==="true")return;const n=t.getAttribute("aria-controls");if(!n)return;const s=e.getElementById(n);s&&qe(t,s)})},pt=e=>{if(!e)return;const t=we();ce.forEach(n=>{const{toggle:s}=n;(!s||!(t!=null&&t.contains)||!t.contains(s)||e.contains(s))&&ce.delete(n)})};mt();let V=null,he=null,Q=null,W=null,ze=!1,Ce=!1;const le=Ht(window),J=Gt(window),re=nn(),gt=e=>{var t,n;I&&(e?(I.disabled=!1,(t=I.removeAttribute)==null||t.call(I,"aria-disabled")):(I.disabled=!0,(n=I.setAttribute)==null||n.call(I,"aria-disabled","true")))},ht=e=>{var t,n;if(g){if(e){g.hidden=!0,g.disabled=!1,(t=g.removeAttribute)==null||t.call(g,"aria-disabled");return}g.hidden=!1,g.disabled=!1,(n=g.removeAttribute)==null||n.call(g,"aria-disabled")}},X=()=>{const e=!!V;gt(e),ht(e)},Be=e=>{var t,n;if(g){if(e){g.disabled=!0,(t=g.setAttribute)==null||t.call(g,"aria-disabled","true");return}g.disabled=!1,(n=g.removeAttribute)==null||n.call(g,"aria-disabled")}};X();const $=(e,t="info")=>{L&&(L.textContent=e,L.classList.toggle("is-success",t==="success"),L.classList.toggle("is-error",t==="error"))},ye={read:"No se pudo acceder al almacenamiento local en este navegador. El token no se recordará automáticamente.",write:"No se pudo recordar el token en este navegador. El token solo estará disponible en esta sesión.",remove:"No se pudo actualizar el token almacenado en este navegador. El token podría seguir guardado.",clear:"No se pudo olvidar el token almacenado en este navegador. Es posible que debas borrarlo manualmente.",generic:"No se pudo acceder al almacenamiento local en este navegador."},ve=()=>{m&&(m.checked=!1,m.disabled=!0,m.setAttribute("data-storage-unavailable","true"))},yt=e=>(Array.isArray(e==null?void 0:e.errors)?e.errors:[]).some(n=>(n==null?void 0:n.storage)==="localStorage"),bt=e=>e!=null&&e.storageLabel?e.storageLabel:(e==null?void 0:e.storage)==="sessionStorage"?"el almacenamiento de sesión":"un almacenamiento alternativo",Et=e=>{const t=bt(e);return(e==null?void 0:e.operation)==="read"?`Se recuperó el token usando ${t} porque el almacenamiento local no está disponible. El token se conservará solo durante esta sesión.`:e!=null&&e.persisted?`El token se recordará usando ${t} porque el almacenamiento local no está disponible.`:`No se pudo usar el almacenamiento local. El token se guardará solo durante esta sesión (${t}).`},oe=(e,{message:t,tone:n="error",silent:s=!1}={})=>{if(!e)return{handled:!1};if(e.ok===!1){ve();const r=t||ye[e.operation]||ye.generic;return s||$(r,n),{handled:!0,message:r,tone:n,status:e}}if(e.fallbackUsed){ve();const r=t||Et(e),o=n??"error";return s||$(r,o),{handled:!0,message:r,tone:o,status:e}}if(e.hadErrors&&yt(e)){ve();const r=t||ye[e.operation]||ye.generic;return s||$(r,n),{handled:!0,message:r,tone:n,status:e}}return{handled:!1,status:e}},Fe=(e,t)=>{e&&(t?(e.setAttribute("data-initial-loading","true"),e.setAttribute("aria-busy","true")):(e.removeAttribute("data-initial-loading"),e.removeAttribute("aria-busy")),e.querySelectorAll("input, select, textarea, button").forEach(n=>sn(n,t)))},De=e=>{ze!==e&&(ze=e,i.classList.toggle("initial-loading",e),e?(se==null||se.setAttribute("aria-busy","true"),ae&&(ae.hidden=!1,ae.textContent="Cargando datos iniciales…")):(se==null||se.removeAttribute("aria-busy"),ae&&(ae.hidden=!0)),Fe(b,e),Fe(x,e))},He=e=>{var s,r,o;if(!P||Ce===e){Ce=e;return}Ce=e;const t=P.dataset??null;if(e){t&&(t.logsLoadingWasDisabled=P.disabled?"true":"false"),P.disabled=!0,(s=P.setAttribute)==null||s.call(P,"aria-disabled","true");return}const n=(t==null?void 0:t.logsLoadingWasDisabled)==="true";if(t&&delete t.logsLoadingWasDisabled,n){P.disabled=!0,(r=P.setAttribute)==null||r.call(P,"aria-disabled","true");return}P.disabled=!1,(o=P.removeAttribute)==null||o.call(P,"aria-disabled")},Ge=e=>{C&&(e?C.setAttribute("aria-busy","true"):C.removeAttribute("aria-busy")),q&&(e?q.setAttribute("aria-busy","true"):q.removeAttribute("aria-busy"))},be=le.readToken();W=(be==null?void 0:be.token)??null;const Ve=oe(be,{silent:!0}),St=()=>{y&&(y.innerHTML=""),V=null,X(),x&&x.reset(),D&&D.querySelectorAll(".config-field.is-error").forEach(e=>{e.classList.remove("is-error"),e.querySelectorAll(".value-input").forEach(t=>t.removeAttribute("aria-invalid"))}),N&&(N.value="cron"),te&&(te.hidden=!1),j&&(j.disabled=!1,j.value="",j.removeAttribute("aria-invalid")),ne&&(ne.hidden=!0),z&&(z.disabled=!0,z.value="",z.removeAttribute("aria-invalid")),R&&(R.hidden=!0,R.classList.remove("success","error"),R.textContent=""),he=null,E&&(E.hidden=!0,E.classList.remove("success","error"),E.textContent=""),F&&(F.hidden=!0,F.classList.remove("success","error"),F.textContent=""),C&&(C.innerHTML="",C.disabled=!0),q&&(q.textContent="Introduce un token válido para ver los logs."),B&&(B.textContent="")},Ke=e=>{i.classList.toggle("authenticated",e),i.classList.toggle("requires-auth",!e),e||(De(!1),St())},Y={getToken:()=>Q,setToken:(e,{persist:t=!1}={})=>{if(Q=(typeof e=="string"?e.trim():"")||null,!Q)return W=null,le.clearToken("remove");if(t){const s=le.persistToken(Q);return s!=null&&s.ok&&(W=Q),s}return W=null,le.clearToken("remove")},clearToken:({forgetPersisted:e=!0}={})=>{if(Q=null,!e)return{ok:!0,operation:"memory-clear",storage:null,storageLabel:null,persisted:!1,fallbackUsed:!1,attempts:[],errors:[],hadErrors:!1};const t=le.clearToken("clear");return t!=null&&t.ok&&(W=null),t}},We=async(e,{persist:t=!1}={})=>{const n=typeof e=="string"?e.trim():"";if(!n){const a=new Error("TOKEN_REQUIRED");throw a.code="TOKEN_REQUIRED",a}let s;try{s=await fetch(J("auth-check"),{headers:{Authorization:`Bearer ${n}`}})}catch(a){const T=new Error("NETWORK_ERROR");throw T.cause=a,T}let r=null,o=null;if(s.status!==204)try{r=await s.json()}catch(a){o=a}if(s.status===401){const a=new Error("UNAUTHORIZED");throw a.status=s.status,o||(a.payload=r),a}if(!s.ok){const a=new Error("REQUEST_FAILED");throw a.status=s.status,o||(a.payload=r),a}if(o){const a=new Error("INVALID_RESPONSE");throw a.cause=o,a}return{success:!0,storageStatus:Y.setToken(n,{persist:t})}},ue=en({auth:Y,buildApiUrl:J,handleUnauthorized:(e,t="El token ha caducado o es incorrecto. Introduce uno nuevo.")=>{const{message:n,reason:s}=_e(e,t);if(s==="missing-credentials"){const T=Ue(n);H("error",T);return}const r=Q!=null,o=Y.clearToken();W=null;const h=oe(o,{silent:!0});l==null||l.reset();const a=Wt(n,{hadMemoryToken:r,storageOutcome:h});H("error",a)},createUnauthorizedError:()=>{const e=new Error("UNAUTHORIZED");return e.status=401,e}}),Ze=Vt({authorizedFetch:ue,buildApiUrl:J}),Qe=e=>{const t=String(e);return typeof CSS<"u"&&typeof CSS.escape=="function"?CSS.escape(t):t.replace(/([\s!"#$%&'()*+,./:;<=>?@[\\\]^`{|}~])/g,"\\$1")},Lt=e=>{if(e&&typeof e=="object"){const t=typeof e.summary=="string"&&e.summary.trim().length?e.summary.trim():typeof e.text=="string"?e.text:typeof e.message=="string"?e.message:"",s=(Array.isArray(e.details)?e.details:e.details!=null?[e.details]:[]).map(r=>r==null?null:typeof r=="string"?r:typeof r=="object"?r.message||r.text||r.detail||JSON.stringify(r):String(r)).filter(r=>typeof r=="string"&&r.trim().length).map(r=>r.trim());return{summary:t,details:s}}return typeof e=="string"?{summary:e,details:[]}:{summary:e!=null?String(e):"",details:[]}},v=(e,t,n="info")=>{if(!e)return;const{summary:s,details:r}=Lt(t);if(e.textContent="",s){const o=document.createElement("span");o.textContent=s,e.appendChild(o)}if(r.length){const o=document.createElement("ul");r.forEach(h=>{const a=document.createElement("li");a.textContent=h,o.appendChild(a)}),e.appendChild(o)}e.hidden=!1,e.classList.toggle("success",n==="success"),e.classList.toggle("error",n==="error")},M=e=>{e&&(re.clear(e),e.hidden=!0,e.classList.remove("success","error"),e.textContent="")},At=e=>{k&&(e?(k.dataset.loading="true",k.disabled=!0,k.setAttribute("aria-disabled","true")):(delete k.dataset.loading,k.disabled=!1,k.removeAttribute("aria-disabled")))},Je=(e,t,n)=>{if(!e)return;const s=e.dataset??{},r=`${t}Busy`;if(n){s[r]="true",e.setAttribute("aria-busy","true");return}if(delete s[r],s.initialLoading==="true"){e.setAttribute("aria-busy","true");return}Object.entries(s).some(([h,a])=>h!=="initialLoading"&&h.endsWith("Busy")&&a==="true")||e.removeAttribute("aria-busy")},Ee=(e,t,n)=>{var a,T,A;if(!e)return;const s=e.dataset??{},r=`${t}Pending`,o=`${t}WasDisabled`;if(n){s[r]="true",s[o]=e.disabled?"true":"false",e.disabled=!0,(a=e.setAttribute)==null||a.call(e,"aria-disabled","true");return}if(s[r]!=="true")return;const h=s[o]==="true";delete s[r],delete s[o],h?(e.disabled=!0,(T=e.setAttribute)==null||T.call(e,"aria-disabled","true")):(e.disabled=!1,(A=e.removeAttribute)==null||A.call(e,"aria-disabled"))},Se=e=>{Je(b,"configSubmitting",e),Ee(S,"configSubmitting",e),Ee(I,"configSubmitting",e)},Xe=e=>{Je(x,"scheduleSubmitting",e),Ee(lt,"scheduleSubmitting",e),Ee(ge,"scheduleSubmitting",e)},ee=(e=y)=>{e&&e.querySelectorAll(".config-field.is-error").forEach(t=>{t.classList.remove("is-error"),t.querySelectorAll(".value-input").forEach(n=>n.removeAttribute("aria-invalid"))})},Ye=[{name:"BASE_DIR",message:"Indica un directorio base absoluto y existente antes de guardar."},{name:"LOG_DIR",message:"Indica un directorio de logs absoluto y existente antes de guardar."}],Re=e=>{if(!e||typeof e!="object")return Ye.slice();const t=[];return Ye.forEach(n=>{const s=e[n.name];(typeof s=="string"?s.trim():s!=null?String(s).trim():"")||t.push({field:n.name,message:n.message})}),t},et=(e,t=null)=>{if(e==null)return[];const n=[],s=(r,o)=>{if(r==null)return;const h=typeof r;if(h==="string"||h==="number"||h==="boolean"){o?n.push({field:o,message:r}):n.push(String(r));return}if(Array.isArray(r)){r.forEach(a=>s(a,o));return}if(h==="object"){const a=r.field??r.name??r.key??null,T=["message","error","detail"].find(p=>{const w=r[p];return typeof w=="string"||typeof w=="number"||typeof w=="boolean"});if(a||T){const p={...r};!a&&o&&(p.field=o),n.push(p);return}const A=new Set(["message","error","detail","errors","non_field_errors"]);Object.entries(r).forEach(([p,w])=>{const d=A.has(p)?o:o||p;s(w,d)});return}n.push(String(r))};return s(e,t),n},ie=(e,t=y)=>{if(!t)return[];const n=et(e),s=[];return n.forEach(r=>{if(r!=null){if(typeof r=="string"){const o=r.trim();o&&s.push(o);return}if(typeof r=="object"){const o=r.field||r.name||r.key||null,h=r.message||r.error||r.detail||JSON.stringify(r),a=typeof h=="string"&&h.trim().length?h.trim():typeof h=="string"?h:String(h);if(o){const T=`.config-field[data-name="${Qe(o)}"]`,A=t.querySelector(T);A&&(A.classList.add("is-error"),A.querySelectorAll(".value-input").forEach(p=>p.setAttribute("aria-invalid","true"))),s.push(`${o}: ${a}`)}else a&&s.push(a);return}s.push(String(r))}}),s},Le=e=>{if(e==null)return"";const t=typeof e;if(t==="string")return e.trim();if(t==="number"||t==="boolean")return String(e);if(Array.isArray(e)){for(const n of e){const s=Le(n);if(s)return s}return""}if(t==="object"){const n=["error","detail","message","title"];for(const s of n)if(Object.prototype.hasOwnProperty.call(e,s)){const r=Le(e[s]);if(r)return r}for(const s of Object.values(e)){const r=Le(s);if(r)return r}}return""},Tt=e=>{if(e==null)return null;if(Array.isArray(e))return e;if(typeof e=="object"){if(e.details!==void 0)return e.details;if(e.detail!==void 0)return e.detail;if(e.errors!==void 0)return e.errors;if(Array.isArray(e.message)||typeof e.message=="object"&&e.message!==null)return e.message;if(Array.isArray(e.error)||typeof e.error=="object"&&e.error!==null)return e.error;const t=new Set(["error","detail","message","title","status","type","code"]),n=Object.entries(e).filter(([s])=>!t.has(s));if(n.length)return Object.fromEntries(n)}return null},xe=(e,{defaultSummary:t="No se pudo guardar la configuración.",container:n=y}={})=>{const s=Tt(e),r=et(s),o=[];typeof e=="string"||typeof e=="number"||typeof e=="boolean"?o.push(e):Array.isArray(e)?o.push(...e):e&&typeof e=="object"&&o.push(e.error,e.detail,e.message,e.title),!o.length&&r.length&&o.push(...r);const h=o.map(T=>Le(T)).find(T=>T==null?void 0:T.length)||t,a=ie(s,n);return{summary:h,details:a}},tt=(e,t=400)=>{if(typeof e!="string")return"";const n=e.trim();return n?n.length<=t?n:`${n.slice(0,t).trimEnd()}…`:""},kt=e=>{const t={summary:"",details:[],tone:"info"};if(!e||typeof e!="object")return t.summary="La ejecución finalizó, pero no se recibió respuesta del backend.",t.tone="error",t;const n=e.status==="success"?"success":e.status==="error"?"error":"info",s=typeof e.message=="string"&&e.message.trim().length?e.message.trim():n==="success"?"El comando de prueba finalizó correctamente.":n==="error"?"El comando de prueba finalizó con errores.":"Resultado recibido.";t.summary=s,t.tone=n==="success"?"success":n==="error"?"error":"info",typeof e.exit_code=="number"&&t.details.push(`Código de salida: ${e.exit_code}`);const r=tt(e.stdout);r&&t.details.push(`STDOUT: ${r}`);const o=tt(e.stderr);return o&&t.details.push(`STDERR: ${o}`),(Array.isArray(e.errors)?e.errors:[]).map(a=>{if(typeof a=="string")return a.trim();if(a&&typeof a=="object"){const T=typeof a.message=="string"?a.message:typeof a.detail=="string"?a.detail:typeof a.error=="string"?a.error:null;return T?T.trim():null}return null}).filter(a=>a&&a.length).forEach(a=>{t.details.push(a)}),t},wt=e=>{const t=(e==null?void 0:e.mode)==="once"?"once":"cron",n=typeof(e==null?void 0:e.expression)=="string"?e.expression.trim():"",s=typeof(e==null?void 0:e.datetime)=="string"?e.datetime.trim():"";return t==="cron"?{mode:t,expression:n,datetime:""}:{mode:t,expression:"",datetime:s}},Ae=e=>{const t=e==="once"?"once":"cron";N&&(N.value=t),te&&(te.hidden=t!=="cron"),j&&(j.disabled=t!=="cron",t!=="cron"&&j.removeAttribute("aria-invalid")),ne&&(ne.hidden=t!=="once"),z&&(z.disabled=t!=="once",t!=="once"&&z.removeAttribute("aria-invalid"))},de=e=>{const t=wt(e);N&&(N.value=t.mode),Ae(t.mode),ee(D),j&&(j.value=t.expression),z&&(z.value=t.datetime),he=t},It=()=>{const e=[],t=(N==null?void 0:N.value)??"",n=t==="once"?"once":t==="cron"?"cron":null,s={};if(!n)return e.push({field:"mode",message:"Selecciona un modo válido."}),{payload:null,errors:e};if(s.mode=n,n==="cron"){const r=((j==null?void 0:j.value)??"").trim();r?s.expression=r:e.push({field:"expression",message:"Indica una expresión cron."})}else{const r=((z==null?void 0:z.value)??"").trim();r?Number.isNaN(Date.parse(r))?e.push({field:"datetime",message:"Usa un formato ISO 8601 válido (ej.: 2030-05-10T12:30:00+02:00)."}):s.datetime=r:e.push({field:"datetime",message:"Indica una fecha y hora válidas."})}return{payload:s,errors:e}},Ct=async({showLoadingStatus:e=!1}={})=>{ee(D),e?v(R,"Cargando programación…"):M(R);try{const t=await Ze.load(),n=await t.json().catch(()=>null);if(!t.ok){const s=new Error("REQUEST_FAILED");throw s.status=t.status,s.data=n,s}return de(n||{mode:"cron",expression:"",datetime:""}),v(R,"Programación cargada correctamente.","success"),re.schedule(R,()=>M(R),2500),!0}catch(t){return console.error(t),(t==null?void 0:t.message)==="UNAUTHORIZED"?v(R,"No se pudo cargar la programación: introduce un token válido.","error"):v(R,"No se pudo cargar la programación.","error"),!1}},vt=async e=>{e.preventDefault(),M(R),ee(D);const{payload:t,errors:n}=It();if(n.length){const s=ie(n,D);v(R,{summary:"Revisa la programación antes de guardar.",details:s},"error");return}Xe(!0);try{const s=await Ze.save(t),r=await s.json().catch(()=>null);if(!s.ok){const o=new Error("REQUEST_FAILED");throw o.status=s.status,o.data=r,o}r?de(r):t&&de(t),v(R,"Programación guardada.","success"),re.schedule(R,()=>M(R),2500)}catch(s){if(console.error(s),(s==null?void 0:s.message)==="UNAUTHORIZED"){v(R,"No se pudo guardar la programación porque falta un token válido.","error");return}if(s!=null&&s.data){const r=xe(s.data,{defaultSummary:"No se pudo guardar la programación.",container:D});v(R,r,"error");return}v(R,"No se pudo guardar la programación. Revisa los datos e inténtalo de nuevo.","error")}finally{Xe(!1)}},Dt=()=>{if(ee(D),!he){x==null||x.reset(),Ae((N==null?void 0:N.value)??"cron"),M(R);return}de(he),v(R,"Se restauró la programación cargada."),re.schedule(R,()=>M(R),2500)},Rt=e=>typeof e=="boolean"?e:typeof e=="string"?e.toLowerCase()==="true":!!e,xt=(e,t)=>{var n,s,r,o;e&&("required"in e&&(e.required=!!t),t?((n=e.setAttribute)==null||n.call(e,"required",""),(s=e.setAttribute)==null||s.call(e,"aria-required","true")):((r=e.removeAttribute)==null||r.call(e,"required"),(o=e.removeAttribute)==null||o.call(e,"aria-required")))},Nt=(e,t)=>{var a,T,A,p,w;if(!e||!t)return;const n=t.constraints&&typeof t.constraints=="object"?t.constraints:{},s=n.allow_empty===!0,o=String(e.tagName||"").toUpperCase()==="SELECT";t.type==="boolean"||xt(e,!s),o||(typeof n.pattern=="string"&&n.pattern&&(e.pattern=n.pattern,(a=e.setAttribute)==null||a.call(e,"pattern",n.pattern)),typeof n.min_length=="number"&&(e.minLength=n.min_length,(T=e.setAttribute)==null||T.call(e,"minlength",String(n.min_length))),typeof n.max_length=="number"&&(e.maxLength=n.max_length,(A=e.setAttribute)==null||A.call(e,"maxlength",String(n.max_length)))),(t.type==="integer"||e.type==="number")&&(typeof n.min=="number"&&(e.min=String(n.min),(p=e.setAttribute)==null||p.call(e,"min",String(n.min))),typeof n.max=="number"&&(e.max=String(n.max),(w=e.setAttribute)==null||w.call(e,"max",String(n.max))))},Ot=(e,t,n)=>{if(!e||!t||(t.constraints&&typeof t.constraints=="object"?t.constraints:{}).allow_empty!==!0)return;const r=document.createElement("option");r.value="",r.textContent="— Selecciona una opción —",r.dataset.placeholder="true",(n==null||n==="")&&(r.selected=!0),e.appendChild(r)},_t=()=>{var n;if(!y)return[];const e=(n=V==null?void 0:V.schema)==null?void 0:n.variables;if(!Array.isArray(e))return[];const t=[];return e.forEach(s=>{var O;if(!(s!=null&&s.name))return;const r=`.config-field[data-name="${Qe(s.name)}"]`,o=y.querySelector(r);if(!o)return;const h=((O=o.querySelector)==null?void 0:O.call(o,".value-input"))??null;if(!h||s.type==="boolean")return;const a=s.constraints&&typeof s.constraints=="object"?s.constraints:{},T=a.allow_empty===!0,A=h.value??"",p=typeof A=="string"?A:A==null?"":String(A),w=p.trim(),d=s.name==="BASE_DIR"||s.name==="LOG_DIR"?w:p;if(s.type==="integer"){if(!w){T||t.push({field:s.name,message:"Indica un valor."});return}if(!/^[-+]?\d+$/.test(w)){t.push({field:s.name,message:"Debe ser un número entero."});return}const _=Number(w);if(Number.isNaN(_)){t.push({field:s.name,message:"Debe ser un número entero."});return}if(typeof a.min=="number"&&_<a.min){t.push({field:s.name,message:`Debe ser como mínimo ${a.min}.`});return}if(typeof a.max=="number"&&_>a.max){t.push({field:s.name,message:`No puede ser mayor que ${a.max}.`});return}return}if(!w){T||t.push({field:s.name,message:"Indica un valor."});return}if(typeof a.min_length=="number"&&d.length<a.min_length){t.push({field:s.name,message:`Debe tener al menos ${a.min_length} caracteres.`});return}if(typeof a.max_length=="number"&&d.length>a.max_length){t.push({field:s.name,message:`No puede superar ${a.max_length} caracteres.`});return}if(typeof a.pattern=="string"&&a.pattern&&d)try{new RegExp(a.pattern).test(d)||t.push({field:s.name,message:"El valor no cumple el formato esperado."})}catch{}}),t},Ut=(e,t)=>{const n=document.createElement("div");n.className="field-description info-disclosure";const s=document.createElement("button");s.type="button",s.className="info-toggle",s.setAttribute("aria-expanded","false"),s.setAttribute("aria-controls",e);const r=document.createElement("span");r.className="info-toggle-icon",r.setAttribute("aria-hidden","true"),r.textContent="i",s.appendChild(r);const o=document.createElement("span");o.className="sr-only",o.textContent=`Mostrar ayuda para ${t}`,s.appendChild(o);const h=document.createElement("div");return h.className="info-panel",h.id=e,h.setAttribute("role","tooltip"),h.hidden=!0,n.appendChild(s),n.appendChild(h),qe(s,h),{container:n,panel:h}},Pt=(e,t)=>{var ot;const n=document.createElement("div");n.className="config-field",n.dataset.name=e.name;const s=document.createElement("label");s.htmlFor=`field-${e.name}`,s.dataset.variable=e.name;const r=e.name==="BASE_DIR",o=e.name==="LOG_DIR",h=Pe(Qt[e.name],e.label,(ot=e.metadata)==null?void 0:ot.label)||e.name,a=document.createElement("span");a.className="field-label-text",a.textContent=h,s.appendChild(a);const T=document.createElement("span");T.className="field-variable",T.textContent=e.name,s.appendChild(T),n.appendChild(s);const A=document.createElement("div");A.className="field-input";const w=t&&Object.prototype.hasOwnProperty.call(t,e.name)?t[e.name]:e.default;let d;if(r||o){d=document.createElement("input"),d.type="text",d.id=`field-${e.name}`,d.classList.add("value-input"),r?d.classList.add("base-dir-input"):o&&d.classList.add("log-dir-input"),d.dataset.type=e.type;const U=r?"Introduce una ruta absoluta (ej.: /ruta/a/proyectos)":"Introduce una ruta absoluta existente";d.placeholder=U,d.spellcheck=!1,d.value=w??""}else if(e.type==="boolean")d=document.createElement("input"),d.type="checkbox",d.id=`field-${e.name}`,d.className="value-input",d.dataset.type="boolean",d.checked=Rt(w);else if(e.constraints&&Array.isArray(e.constraints.allowed_values)&&e.constraints.allowed_values.length>0){d=document.createElement("select"),d.id=`field-${e.name}`,d.className="value-input",d.dataset.type=e.type;const U=e.constraints.allowed_values;Ot(d,e,w),U.forEach(Z=>{const G=document.createElement("option");G.value=Z,G.textContent=Z,String(Z)===String(w)&&(G.selected=!0),d.appendChild(G)})}else e.name==="EXCLUDE_PROJECTS"?(d=document.createElement("textarea"),d.id=`field-${e.name}`,d.classList.add("value-input","multiline-input"),d.dataset.type=e.type,d.placeholder="Introduce rutas absolutas a excluir, una por línea",d.spellcheck=!1,d.rows=Math.max(3,String(w??"").split(/\n/).length),d.value=w??""):(d=document.createElement(e.multiline?"textarea":"input"),e.multiline&&d.classList.add("multiline-input"),d.id=`field-${e.name}`,d.classList.add("value-input"),d.dataset.type=e.type,e.type==="integer"?(d.type="number",d.step="1"):e.multiline||(d.type="text"),d.value=w??"");d&&(Nt(d,e),d.setAttribute("aria-describedby",`field-${e.name}-description`)),A.appendChild(d);const O=`field-${e.name}-description`;n.appendChild(A);const{container:_,panel:K}=Ut(O,h||e.name);if(r||o){const U=[];e.description&&U.push(e.description),r?(U.push("Ruta absoluta de la carpeta donde se buscarán los proyectos Docker Compose."),U.push("Debe existir antes de ejecutar el script y contener los proyectos docker-compose en sus subdirectorios.")):(U.push("Directorio absoluto donde se almacenarán los logs diarios del updater."),U.push("Asegúrate de crear la carpeta con permisos de escritura antes de lanzar el script.")),U.length&&U.forEach(Z=>{const G=document.createElement("p");G.textContent=Z,K.appendChild(G)})}else{const U=document.createElement("p");if(U.textContent=e.description||"Sin descripción",K.appendChild(U),e.name==="EXCLUDE_PROJECTS"){const Z=document.createElement("p");Z.textContent="Introduce rutas absolutas que no deban procesarse (se ignorarán subdirectorios).",K.appendChild(Z);const G=document.createElement("p");G.textContent="Ejemplo: /srv/app para omitir tanto /srv/app como cualquier carpeta dentro.",K.appendChild(G)}}if(e.default!==void 0&&e.default!==null&&String(e.default).length){const U=document.createElement("p");U.className="field-default",U.textContent=`Valor por defecto: ${e.default}`,K.appendChild(U)}return n.appendChild(_),n},Ne=e=>{var T;const t=e==null?void 0:e.schema,n=e==null?void 0:e.values;pt(y),y.innerHTML="";const s=[],r=new Map,o=A=>{const p=A&&A.trim().length?A:"General";let w=r.get(p);if(!w){const d=document.createElement("section");d.className="config-section",d.dataset.section=p;const O=document.createElement("h3");O.className="config-section-title",O.textContent=p;const _=document.createElement("div");_.className="config-section-body",d.appendChild(O),d.appendChild(_),w={element:d,body:_,defaultGrid:null,subsections:new Map},r.set(p,w),s.push(p)}return w},h=A=>{if(!A.defaultGrid){const p=document.createElement("div");p.className="config-section-grid",A.body.appendChild(p),A.defaultGrid=p}return A.defaultGrid},a=(A,p)=>{const w=p&&p.trim().length?p:null;if(!w)return h(A);let d=A.subsections.get(w);if(!d){const O=document.createElement("div");O.className="config-subsection",O.dataset.subsection=w;const _=document.createElement("h4");_.className="config-subsection-title",_.textContent=w;const K=document.createElement("div");K.className="config-subsection-grid",O.appendChild(_),O.appendChild(K),A.body.appendChild(O),d={wrapper:O,grid:K},A.subsections.set(w,d)}return d.grid};(T=t==null?void 0:t.variables)==null||T.forEach(A=>{const p=Pt(A,n),{section:w,subsection:d}=Jt(A),O=o(w);a(O,d).appendChild(p)}),s.forEach(A=>{const p=r.get(A);p&&y.appendChild(p.element)}),V=e,X()},Mt=()=>{const e={values:{}};return y.querySelectorAll(".config-field").forEach(t=>{const n=t.dataset.name;if(!n)return;const s=t.querySelector(".value-input");if(!s)return;const r=s.dataset.type;if(r==="boolean")e.values[n]=s.checked;else if(r==="integer")e.values[n]=s.value===""?null:Number(s.value);else{const o=s.value;e.values[n]=n==="BASE_DIR"||n==="LOG_DIR"?o.trim():o}}),e},nt=async({showLoadingStatus:e=!1}={})=>{ee(),e?v(E,"Cargando configuración inicial…"):M(E),Se(!0);try{const t=await ue(J("config"));if(!t.ok)throw new Error(`Error HTTP ${t.status}`);const n=await t.json();Ne(n);const s=Re(n==null?void 0:n.values);return s.length?(ie(s),v(E,{summary:"Configura las rutas obligatorias antes de ejecutar el updater.",details:s},"error")):(v(E,"Configuración cargada correctamente.","success"),re.schedule(E,()=>M(E),2500)),!0}catch(t){return console.error(t),(t==null?void 0:t.message)==="UNAUTHORIZED"?v(E,"No se pudo cargar la configuración: introduce un token válido.","error"):v(E,"Token válido, pero el backend no devolvió la configuración. Revisa el servicio e inténtalo de nuevo.","error"),X(),!1}finally{Se(!1)}},jt=async e=>{e.preventDefault(),M(E),ee();const t=_t();if(t.length){const r=ie(t);v(E,{summary:"Revisa los campos marcados antes de guardar.",details:r},"error");return}const n=Mt(),s=Re(n.values);if(s.length){ie(s),v(E,{summary:"Completa las rutas obligatorias antes de guardar.",details:s},"error");return}Se(!0);try{const r=await ue(J("config"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),o=await r.json().catch(()=>null);if(!r.ok){const h=new Error("REQUEST_FAILED");throw h.status=r.status,h.data=o,h}o&&Ne(o),v(E,"Cambios guardados.","success")}catch(r){if(console.error(r),(r==null?void 0:r.message)==="UNAUTHORIZED"){v(E,"No se pudo guardar la configuración porque falta un token válido.","error");return}if(r!=null&&r.data){const o=xe(r.data);v(E,o,"error");return}v(E,"No se pudo guardar la configuración. Revisa los datos e inténtalo de nuevo.","error")}finally{Se(!1)}},$t=rn({authorizedFetch:ue,buildApiUrl:J,buildProcessStatusMessage:kt,buildErrorStatusPayload:xe,showStatus:v,hideStatus:M,setTestConfigButtonLoading:At,configStatus:E}),qt=()=>{if(!V){X(),v(E,"No hay una configuración cargada para descartar. Usa «Reintentar carga» para intentarlo de nuevo.","error");return}Ne(V);const e=Re(V.values);e.length?(ie(e),v(E,{summary:"Se restauraron los valores cargados. Completa las rutas obligatorias antes de guardar.",details:e},"error")):(v(E,"Se restauraron los valores cargados."),re.schedule(E,()=>M(E),2500))},zt=async()=>{if(g&&!g.disabled){Be(!0);try{await nt({showLoadingStatus:!0})||X()}finally{Be(!1),X()}}},fe=tn(),Oe=async(e=null,{showLoadingStatus:t=!1}={})=>{const n={selection:(C==null?void 0:C.value)??null,disabled:(C==null?void 0:C.disabled)??!1,content:(q==null?void 0:q.textContent)??"",meta:(B==null?void 0:B.textContent)??""};He(!0),t?(v(F,"Cargando lista de logs…"),Ge(!0),C&&(C.disabled=!0),q&&(q.textContent="Cargando logs…")):M(F);const s=fe.start(),{id:r,controller:o,release:h}=s,a=fe.getSignal(o),T=new URL(J("logs"));e&&T.searchParams.set("name",e);const A=T.toString();try{const p=await ue(A,a?{signal:a}:{});if(!p.ok)throw new Error(`Error HTTP ${p.status}`);const w=await p.json();return fe.isLatest(r)?(Bt(w),!0):!1}catch(p){return(p==null?void 0:p.name)==="AbortError"||!fe.isLatest(r)||(console.error(p),(p==null?void 0:p.message)==="UNAUTHORIZED"||(p==null?void 0:p.status)===401?(C&&(C.innerHTML="",C.disabled=!0),B&&(B.textContent=""),v(F,"Introduce un token válido para consultar los logs.","error"),q.textContent="Introduce un token válido para ver los logs."):(C&&(C.disabled=n.disabled,n.selection!=null&&(C.value=n.selection)),B&&(B.textContent=n.meta),q&&(q.textContent=n.content),v(F,"No se pudieron cargar los logs.","error"))),!1}finally{fe.isLatest(r)&&(He(!1),Ge(!1)),h==null||h()}},Bt=e=>{var h,a,T,A;const t=Array.isArray(e.files)?e.files:[],n=e&&typeof e.notice=="string"&&e.notice.trim().length?e.notice.trim():"";if(C.innerHTML="",n?v(F,n,"error"):M(F),t.length===0){const p=document.createElement("option");p.textContent="Sin archivos de log",p.disabled=!0,p.selected=!0,C.appendChild(p),C.disabled=!0,q.textContent=n||"No se encontraron archivos .log en el directorio configurado.",B.textContent=e.log_dir?`Directorio: ${e.log_dir}`:"";return}C.disabled=!1,t.forEach(p=>{const w=document.createElement("option");w.value=p.name;const d=p.modified?new Date(p.modified).toLocaleString():"sin fecha";w.textContent=`${p.name} · ${d}`,C.appendChild(w)});const s=((h=e.selected)==null?void 0:h.name)||((a=C.options[0])==null?void 0:a.value);s&&(C.value=s),q.textContent=Yt(e.selected);const r=(T=e.selected)==null?void 0:T.size,o=(A=e.selected)!=null&&A.modified?new Date(e.selected.modified).toLocaleString():"";B.textContent=Xt({logDir:e.log_dir,modified:o,size:r})},st=async({showSuccessMessage:e=!0,storageStatus:t=null}={})=>{De(!0),M(E),M(R),M(F),l&&l.reset(),Ke(!0);let n=!1,s=!1,r=!1;try{[n,s,r]=await Promise.all([nt({showLoadingStatus:!0}),Ct({showLoadingStatus:!0}),Oe(null,{showLoadingStatus:!0})])}finally{De(!1)}if(!Y.getToken())return;const o=oe(t,{silent:!0}),h=o.handled?(o.message||"").trim():"",a=[];if(n||a.push("la configuración"),s||a.push("la programación"),r||a.push("los logs"),a.length){const p=`Token validado, pero no se pudo cargar ${(d=>{if(d.length===1)return d[0];const O=d.slice(0,-1).join(", "),_=d[d.length-1];return`${O} y ${_}`})(a)}. Revisa el servicio e inténtalo de nuevo.`,w=h?`${p} ${h}`:p;$(w,"error")}else o.handled?$(h,o.tone||"error"):e?$("Token validado. Puedes usar la interfaz con normalidad.","success"):$("","info")},H=(e="info",t="Introduce el token bearer para continuar. Marca «Recordar token» solo si el equipo es de confianza.")=>{Ke(!1),$(t,e),c==null||c.focus()};l==null||l.addEventListener("submit",async e=>{var s;e.preventDefault();const t=((s=c==null?void 0:c.value)==null?void 0:s.trim())??"";if(!t){$("Debes introducir un token para continuar.","error"),c==null||c.focus();return}$("Verificando token…","info");const n=(m==null?void 0:m.checked)??!1;try{const r=await We(t,{persist:n});await st({storageStatus:r==null?void 0:r.storageStatus})}catch(r){if(console.error(r),(r==null?void 0:r.message)==="UNAUTHORIZED"||(r==null?void 0:r.status)===401){const{message:o,reason:h}=_e(r,"El token proporcionado no está autorizado. Vuelve a intentarlo.");if(h==="missing-credentials"){const a=Y.setToken(t,{persist:n}),T=oe(a,{silent:!0}),A=Ue(o),p=T.handled?(T.message||"").trim():"",w=[A,p].filter(Boolean).join(" ").trim(),d=T.handled?T.tone??"error":"error";$(w,d);return}$(o,"error")}else(r==null?void 0:r.message)==="NETWORK_ERROR"?$("No se pudo verificar el token. Revisa la conexión e inténtalo de nuevo.","error"):(r==null?void 0:r.message)==="TOKEN_REQUIRED"?$("Debes introducir un token para continuar.","error"):$("No se pudo verificar el token. Inténtalo de nuevo.","error")}});const rt=(e="Introduce el token bearer para continuar.",t="info")=>{const n=Y.clearToken(),s=oe(n,{silent:!0});if(l==null||l.reset(),s.handled){H("error",s.message);return}H(t,e)};f==null||f.addEventListener("click",()=>{rt("Se olvidó el token guardado. Introduce uno nuevo.")}),u==null||u.addEventListener("click",()=>{rt("Sesión cerrada. Introduce un token válido para continuar.")}),Ae((N==null?void 0:N.value)??"cron"),N==null||N.addEventListener("change",e=>{var t;Ae(((t=e.target)==null?void 0:t.value)??"cron"),ee(D),M(R)}),x==null||x.addEventListener("submit",vt),ge==null||ge.addEventListener("click",Dt),b.addEventListener("submit",jt),I.addEventListener("click",qt),g==null||g.addEventListener("click",()=>{zt()}),k==null||k.addEventListener("click",$t),C.addEventListener("change",e=>{const{value:t}=e.target;!t||C.disabled||Oe(t)}),P.addEventListener("click",()=>{if(P.disabled)return;const e=C.disabled?null:C.value;Oe(e||null,{showLoadingStatus:!0})}),W?($("Verificando token guardado…","info"),We(W,{persist:!0}).then(e=>st({showSuccessMessage:!1,storageStatus:e==null?void 0:e.storageStatus})).catch(e=>{if(console.error(e),(e==null?void 0:e.message)==="UNAUTHORIZED"||(e==null?void 0:e.status)===401){const{message:n,reason:s}=_e(e,"El token guardado no es válido. Introduce uno nuevo.");if(s==="missing-credentials"){const a=Ue(n);H("error",a);return}const r=Y.clearToken(),o=oe(r,{silent:!0}),h=o.handled?`${n} ${o.message}`:n;H("error",h)}else(e==null?void 0:e.message)==="NETWORK_ERROR"?H("error","No se pudo verificar el token guardado por un problema de red. Revisa la conexión e inténtalo de nuevo; el token seguirá guardado."):H("error","No se pudo verificar el token guardado. Inténtalo de nuevo o introduce uno nuevo.")})):Ve.handled?H("error",Ve.message):H()};typeof document<"u"&&on();
